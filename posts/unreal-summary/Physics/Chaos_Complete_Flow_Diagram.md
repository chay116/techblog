---
title: "Chaos Physics Complete Flow Diagram"
date: "2025-12-11"
status: "stable"
project: "UnrealEngine"
lang: "ko"
category: "unreal-summary"
track: "Physics"
tags: ["unreal", "Physics"]
engine_version: "** Unreal Engine 5.7"
---
# Chaos Physics Complete Flow Diagram

## 🧭 개요

이 문서는 Chaos Physics 엔진의 전체 실행 흐름을 시각적으로 설명합니다. GT(Game Thread)와 PT(Physics Thread) 간의 데이터 흐름, 솔버 파이프라인, 충돌 검출, Island 시스템 등을 다룹니다.

---

## 🔷 1. 핵심 구조 (Structure)

### 1.1 FPBDRigidsSolver 구조

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              FPBDRigidsSolver                                            │
│                              (물리 솔버 핵심 클래스)                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────────────────────┐  │
│  │  FPBDRigidsSOAs Particles       │  │  FPBDRigidsEvolutionGBF MEvolution          │  │
│  │  (입자 조직 방식)                │  │  (물리 해석의 핵심 클래스)                   │  │
│  └─────────────────────────────────┘  └─────────────────────────────────────────────┘  │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  Proxy 관리                                                                      │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │  TSparseArray<FSingleParticlePhysicsProxy*> SingleParticlePhysicsProxies_PT     │   │
│  │  TArray<FGeometryCollectionPhysicsProxy*> GeometryCollectionPhysicsProxies      │   │
│  │  TArray<FJointConstraintPhysicsProxy*> JointConstraintPhysicsProxies_Internal   │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  제약 컨테이너 (Constraint Containers)                                           │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │  FPBDJointConstraints JointConstraints          // 관절 제약                     │   │
│  │  FPBDSuspensionConstraints SuspensionConstraints // 서스펜션 제약                │   │
│  │  FCollisionConstraints CollisionConstraints      // 충돌 제약                    │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  충돌 검출 시스템                                                                │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │  FSpatialAccelerationBroadPhase BroadPhase      // 광역 충돌 검출                │   │
│  │  FSpatialAccelerationCollisionDetector CollisionDetector                         │   │
│  │  FCCDManager CCDManager                         // 연속 충돌 검출                │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  재질 관리                                                                       │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │  THandleArray QueryMaterials_External           // 외부 쿼리용 재질              │   │
│  │  THandleArray SimMaterials                      // 시뮬레이션용 재질             │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Particle 계층 구조

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           Particle 클래스 계층                                           │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  입자 속성 (Particle Properties):
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │ TArrayCollection → TParticles → TSimpleGeometryParticles → TGeometryParticlesImp   │
  │      → TKinematicGeometryParticlesImp → TRigidParticles → TPBDRigidClusteredParticles │
  │           → TPBDGeometryCollectionParticles                                         │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  입자 핸들 (Particle Handle):
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │ TParticleHandleBase → TGeometryParticleHandleImp → TKinematicGeometryParticleHandleImp │
  │      → TPBDRigidParticleHandleImp → TPBDRigidClusteredParticleHandleImp             │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 PhysicsProxy 계층 구조

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           IPhysicsProxyBase                                              │
│                    (게임 월드와 물리 월드를 연결하는 다리)                                 │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                    │                                                     │
│          ┌────────────────────────┼────────────────────────┐                            │
│          ▼                        ▼                        ▼                            │
│  ┌───────────────────┐  ┌─────────────────────┐  ┌─────────────────────────┐           │
│  │ TPhysicsProxy<T>  │  │ FJointConstraint    │  │ FSuspensionConstraint   │           │
│  │                   │  │ PhysicsProxy        │  │ PhysicsProxy            │           │
│  └─────────┬─────────┘  └─────────────────────┘  └─────────────────────────┘           │
│            │                                                                             │
│  ┌─────────┴──────────────────────────────────────────────────────────┐                │
│  │                                                                     │                │
│  ▼                        ▼                        ▼                   ▼                │
│ FSingleParticle    FGeometryCollection    FClusterUnion    FSkeletalMesh               │
│ PhysicsProxy       PhysicsProxy           PhysicsProxy     PhysicsProxy                │
│ (★ 주력 Proxy)     (파괴 메시)             (클러스터)       (❌ Deprecated)             │
│                                                                                          │
│ FBodyInstance의                                                                         │
│ FPhysicsActorHandle                                                                     │
│ = FSingleParticlePhysicsProxy*                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.4 FChaosMarshallingManager (GT ↔ PT 데이터 관리)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                        FChaosMarshallingManager                                          │
│                    (GT와 PT의 상호작용 데이터 관리)                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  GT → PT (Push Data)                                                             │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │  FPushPhysicsData* ProducerData          // 현재 생산 중인 데이터                 │   │
│  │  TArray<TArray> ExternalQueue            // 외부 큐                              │   │
│  │  TQueue<FPushPhysicsData*> PushDataPool  // Push 데이터 풀                       │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  PT → GT (Pull Data)                                                             │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │  TQueue<FPullPhysicsData*> PullDataQueue // Pull 데이터 큐                       │   │
│  │  TQueue<FPullPhysicsData*> PullDataPool  // Pull 데이터 풀                       │   │
│  │  FPullPhysicsData* CurPullData           // 현재 Pull 데이터                     │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │  데이터 흐름 요약                                                                │   │
│  │                                                                                   │   │
│  │   Game Thread                              Physics Thread                         │   │
│  │       │                                          │                                │   │
│  │       │  FPushPhysicsData                        │                                │   │
│  │       ├─────────────────────────────────────────>│                                │   │
│  │       │  (위치, 속도, 힘 등)                     │                                │   │
│  │       │                                          │                                │   │
│  │       │                     FPullPhysicsData     │                                │   │
│  │       │<─────────────────────────────────────────┤                                │   │
│  │       │                   (시뮬레이션 결과)       │                                │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔶 2. 솔버 메인 루프 (Solver Main Loop)

### 2.1 Physics Step 전체 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                        Chaos Physics Step 전체 흐름                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  Game Thread                                      Worker Thread (Physics)
      │                                                  │
      │  UWorld::StartPhysicsSim                         │
      ├──────────────────────────────────────────────────┤
      │         │                                        │
      │         ▼                                        │
      │  FChaosScene::StartFrame                         │
      │         │                                        │
      │         ▼                                        │
      │  AdvanceAndDispatch_External                     │
      │         │                                        │
      │         ▼                                        │
      │  FPBDRigidsSolver::PushPhysicsState              │
      │         │                                        │
      │         │  ┌──────────────────────────────────┐  │
      │         └─>│ FPhysicsSolverAdvanceTask 생성    │  │
      │            │ 및 실행                           │  │
      │            └──────────────┬───────────────────┘  │
      │                           │                      │
      │                           ▼                      │
      │            ┌──────────────────────────────────┐  │
      │            │ FPhysicsSolverProcessPushDataTask│  │
      │            │        DoTask                    │  │
      │            └──────────────┬───────────────────┘  │
      │                           │                      │
      │                           ▼                      │
      │            ┌──────────────────────────────────┐  │
      │            │ ProcessPushData                  │  │
      │            │ ProcessPushedData_Internal       │  │
      │            │ ProcessSinglePushedData_Internal │  │
      │            └──────────────┬───────────────────┘  │
      │                           │                      │
      │                           ▼                      │
      │            ┌──────────────────────────────────┐  │
      │            │ FPBDRigidsSolver::AdvanceSolverBy│  │
      │            └──────────────┬───────────────────┘  │
      │                           │                      │
      │                           ▼                      │
      │            ┌──────────────────────────────────┐  │
      │            │ FPBDRigidsEvolutionGBF::         │  │
      │            │   AdvanceOneTimeStep             │  │
      │            └──────────────┬───────────────────┘  │
      │                           │                      │
      │                           ▼                      │
      │            ┌──────────────────────────────────┐  │
      │            │   AdvanceOneTimeStepImpl         │  │
      │            │   (핵심 시뮬레이션 스텝)         │  │
      │            └──────────────┬───────────────────┘  │
      │                           │                      │
      │                           ▼                      │
      │            ┌──────────────────────────────────┐  │
      │            │ FillProducerData                 │  │
      │            │ BufferPhysicsResults             │  │
      │            │ FinalizePullData_Internal        │  │
      │            └──────────────────────────────────┘  │
      │                                                  │
      │  UWorld::FinishPhysicsSim                        │
      ├──────────────────────────────────────────────────┤
      │         │                                        │
      │         ▼                                        │
      │  FChaosScene::EndFrame                           │
      │         │                                        │
      │         ▼                                        │
      │  FChaosScene::SyncBodies                         │
      │         │                                        │
      │         ▼                                        │
      │  PullPhysicsStateForEachDirtyProxy_External      │
      │         │                                        │
      │         ▼                                        │
      │  PullFromPhysicsState                            │
      │                                                  │
      ▼                                                  ▼
```

### 2.2 AdvanceOneTimeStepImpl 핵심 스텝

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    AdvanceOneTimeStepImpl (핵심 시뮬레이션 스텝)                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  1. Integrate (적분)                                                                │
  │     목적: 힘과 규칙을 사용하여 Dynamic 입자의 위치와 속도 업데이트                    │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  2. ApplyKinematicTargets                                                           │
  │     목적: Kinematic 입자의 속도, 위치 등 업데이트                                    │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  3. ComputeIntermediateSpatialAcceleration                                          │
  │     목적: 가속 구조 계산, 성능 향상                                                  │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  4. RunBroadPhase (Broad Phase)                                                     │
  │     목적: AABB를 사용하여 어떤 물체가 충돌할 수 있는지 대략적 판단                    │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  5. RunNarrowPhase (Narrow Phase)                                                   │
  │     목적: 접촉점, 침투 거리 등을 계산하여 두 물체가 실제로 교차하는지 검출           │
  │     → 충돌 제약 쌍 생성                                                             │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  6. ApplyConstraintsPhaseCCD                                                        │
  │     목적: CCD 제약이 있을 때 실행 (연속 충돌 검출)                                   │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  7. CreateConstraintGraph                                                           │
  │     목적: 제약 그래프 생성 (입자 = 노드, 제약 = 엣지)                               │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  8. CreateIslands                                                                   │
  │     목적: Island 생성 (최적화 - 연결된 물체 그룹화)                                  │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  9. BuildGroups                                                                     │
  │     목적: 조건을 만족하는 Island를 기록하고 정렬                                     │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  10. FPBDIslandGroupManager::Solve (★ 핵심 해석 단계 ★)                             │
  │      목적: Island 그룹별 제약 해석                                                  │
  │                                                                                     │
  │      ┌───────────────────────────────────────────────────────────────────────────┐ │
  │      │  GatherBodies() → GatherConstraints() → SolveGroupConstraints()           │ │
  │      │       → ScatterConstraints() → ScatterBodies()                            │ │
  │      └───────────────────────────────────────────────────────────────────────────┘ │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  11. ApplyCorrections                                                               │
  │      목적: CCD 수정 단계 (운동량 보존이 보장되지 않을 수 있음)                       │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  12. UpdateSleep                                                                    │
  │      목적: 휴면 상태의 입자 업데이트 및 비활성화                                     │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  13. UpdateDisable                                                                  │
  │      목적: Disable 상태의 입자 업데이트                                             │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  14. ParticleUpdatePosition                                                         │
  │      목적: 입자 파라미터 업데이트, Island 상태 처리                                  │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔷 3. GT → PT 데이터 Push 흐름

### 3.1 SetBodyTransform 예시

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    GT에서 PT로 데이터 Push 예시: SetBodyTransform()                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  Game Thread
      │
      ▼
  SetBodyTransform()
      │
      ▼
  FPhysScene_Chaos::SetKinematicTarget_AssumesLocked()
      │
      ▼
  FChaosEngineInterface::SetKinematicTarget_AssumesLocked()
      │
      ▼
  IPhysicsProxyBase (Proxy를 통해)
      │
      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  TChaosProperty::Write()                                                            │
  │                                                                                     │
  │  template<typename PropertyType>                                                    │
  │  void Write(const PropertyType& InValue, bool bInvalidate,                          │
  │             FDirtyChaosPropertyFlags& Dirty, IPhysicsProxyBase* Proxy)              │
  │  {                                                                                  │
  │      Property = InValue;                                                            │
  │      MarkDirty(bInvalidate, Dirty, Proxy);  // ← DirtySet에 추가                    │
  │  }                                                                                  │
  └─────────────────────────────────────────────────────────────────────────────────────┘
      │
      ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FDirtySet에 Proxy 추가                                                             │
  │                                                                                     │
  │  if (Base->GetDirtyIdx() == INDEX_NONE)  // 중복 방지                               │
  │  {                                                                                  │
  │      Bucket.ProxiesData.Add(Base);                                                  │
  │      Base->SetDirtyIdx(Idx);                                                        │
  │  }                                                                                  │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 ProcessSinglePushedData_Internal

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    ProcessSinglePushedData_Internal (PT에서 Push 데이터 처리)            │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              PushData 처리
                                   │
          ┌────────────────────────┼────────────────────────┐
          ▼                        ▼                        ▼
  ┌───────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
  │ DirtyProxy 처리    │  │ 제약 처리            │  │ 제약 처리            │
  │ (1단계: Body)     │  │ (2단계: Constraint)  │  │                     │
  └─────────┬─────────┘  └──────────┬──────────┘  └─────────────────────┘
            │                       │
            ▼                       ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  Proxy 타입별 처리                                                                  │
  ├─────────────────────────────────────────────────────────────────────────────────────┤
  │                                                                                     │
  │  SingleParticleProxy:                                                               │
  │    └─> PushStateOnPhysicsThread()                                                   │
  │                                                                                     │
  │  GeometryCollectionType:                                                            │
  │    ├─> 초기화 안됨: InitializeBodiesPT()                                            │
  │    └─> PushToPhysicsState()                                                         │
  │                                                                                     │
  │  JointConstraintType:                                                               │
  │    ├─> 초기화 안됨: InitializeOnPhysicsThread()                                     │
  │    │       └─> GetBodyPairs() → FPBDJointConstraints::AddConstraint()              │
  │    └─> CreateParticles() → PushToPhysicsStateImp()                                  │
  │                                                                                     │
  │  SuspensionConstraintType:                                                          │
  │    └─> (JointConstraint와 유사)                                                     │
  │                                                                                     │
  │  CharacterGroundConstraintType:                                                     │
  │    └─> (JointConstraint와 유사)                                                     │
  │                                                                                     │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔶 4. Spatial Acceleration (공간 가속 구조)

### 4.1 가속 구조 계층

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                        Spatial Acceleration 계층 구조                                    │
│                    (충돌 가능한 물체를 빠르게 필터링)                                     │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                          ISpatialAcceleration
                                   │
                                   ▼
                    ISpatialAccelerationCollection
                                   │
                                   ▼
                    TSpatialAccelerationCollection
                          ┌────────┴────────┐
                          ▼                 ▼
                  TBoundingVolume    TAABBTree
                                     (Static용)
                          │
                          ▼
              TBoundingVolumeHierarchy
                     (Dynamic용)

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  TSpatialAccelerationCollection 구조                                                │
  ├─────────────────────────────────────────────────────────────────────────────────────┤
  │                                                                                     │
  │  uint32 NumTypes                                                                    │
  │  TSpatialTypeTuple<...> Types               // 가속 구조 타입                       │
  │  TSpatialCollectionBucket<> Buckets[8]      // 기본 1개 사용                        │
  │  uint16 MaxBuckets = 8                                                              │
  │                                                                                     │
  │  기본적으로 두 가지 Object:                                                          │
  │    - Static: AABBTreeType                                                           │
  │    - Dynamic: AABBDynamicTreeType                                                   │
  │                                                                                     │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 가속 구조 계산 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    ComputeIntermediateSpatialAcceleration 흐름                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                     시작
                       │
                       ▼
        ┌──────────────────────────────┐
        │ AccelerationStructureTask    │
        │ Complete가 존재하고          │
        │ 비동기 작업이 완료되었는가?   │
        └──────────────┬───────────────┘
               ┌───────┴───────┐
               │ Yes           │ No
               ▼               ▼
  ┌─────────────────────┐  ┌─────────────────────┐
  │ 관련 가속 구조에    │  │ 계속 진행           │
  │ 값 할당             │  │                     │
  └─────────┬───────────┘  └─────────────────────┘
            │
            ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FlushInternalAccelerationQueue                                                     │
  │                                                                                     │
  │  1. GetFreeSpatialAcceleration_Internal에서 가속 구조 획득                          │
  │     → InternalAcceleration                                                          │
  │     → AsyncInternalAcceleration                                                     │
  │     → AsyncExternalAcceleration                                                     │
  │                                                                                     │
  │  2. ExternalStructuresPool이 비어있으면:                                            │
  │     CreateEmptyCollection()으로 FAccelerationStructure 생성                         │
  │     → AccelerationBackingBuffer에 추가                                              │
  │                                                                                     │
  │  3. AsyncExternalAcceleration을 ExternalStructuresQueue에 Push                      │
  └─────────────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
        ┌──────────────────────────────┐
        │ bCanStartAsyncTasks가        │
        │ true인가?                    │
        └──────────────┬───────────────┘
               ┌───────┴───────┐
               │ Yes           │ No
               ▼               ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FChaosAccelerationStructureTask 생성                                               │
  │  → AccelerationStructureTaskComplete에 할당                                         │
  │                                                                                     │
  │  DoTask → UpdateStructure → FlushInternalAccelerationQueue                          │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔷 5. Broad Phase (광역 충돌 검출)

### 5.1 Broad Phase 전체 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    FSpatialAccelerationCollisionDetector::RunBroadPhase                  │
│                              (광역 충돌 검출 단계)                                        │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                         시작
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FPBDCollisionConstraints::BeginDetectCollisions                                    │
  │                                                                                     │
  │  1. ResetActiveConstraints: 활성화된 제약 비활성화                                  │
  │  2. ContextAllocators 초기화: CurrentEpoch 타임스탬프 카운터 초기화                 │
  │  3. bInCollisionDetectionPhase = true                                               │
  │  4. CurrentEpoch 증가 (현재 프레임의 충돌 데이터 식별)                              │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FSpatialAccelerationBroadPhase::ProduceOverlaps                                    │
  │                                                                                     │
  │  1. BroadphaseContexts 리셋, NumActiveBroadphaseContexts 리셋                       │
  │  2. NonDisabledDynamicView 입자들로 ComputeParticlesOverlaps 호출                   │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
           ┌───────────────┴───────────────┐
           ▼                               ▼
  ┌─────────────────────┐        ┌─────────────────────────────┐
  │ bNeedsResim = false │        │ bNeedsResim = true          │
  │                     │        │ DesyncedView 입자로         │
  │ DynamicSleepingView │        │ ComputeParticlesOverlaps    │
  │ vs                  │        │ 호출                        │
  │ DynamicMovingKinematic│       └─────────────────────────────┘
  │ View                │
  │ (더 적은 쪽 처리)   │
  └─────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FSpatialAccelerationBroadPhase::ProduceParticleOverlaps                            │
  │                                                                                     │
  │  1. WorkerThread당 하나의 BroadphaseContext 생성                                    │
  │  2. ParallelFor로 ProduceOverlapsWorker 실행                                        │
  │  3. TSpatialAccelerationCollection::Overlap 호출                                    │
  │     → TAABBTree::OverlapFast (Static용)                                             │
  │     → AABB Overlap 검사                                                             │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  결과: Context.Overlaps에 잠재적 충돌 쌍 저장                                       │
  │  → 후속 MidPhase 생성에 사용                                                        │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 AABB Tree Overlap 검사

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    TAABBTree::OverlapFast 검사 흐름                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                     NodeStack 순회
                           │
                           ▼
          ┌────────────────────────────────┐
          │      Node.bLeaf인가?           │
          └────────────────┬───────────────┘
                   ┌───────┴───────┐
                   │ Yes (Leaf)    │ No (Internal)
                   ▼               ▼
  ┌─────────────────────┐  ┌─────────────────────────────┐
  │  Leaf 노드 처리      │  │  Internal 노드 처리         │
  │                     │  │                             │
  │  OverlapFast/       │  │  자식 노드를 NodeStack에    │
  │  SweepFast/         │  │  추가하여 순서대로 처리     │
  │  RaycastFastSimd    │  │                             │
  └─────────┬───────────┘  └─────────────────────────────┘
            │
            ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  TAABBTreeLeafArray::OverlapFast                                                    │
  │                                                                                     │
  │  DirtyElements 순회 → IntersectAndVisit 실행                                        │
  │                                                                                     │
  │  ┌─────────────────────────────────────────────────────────────────────────────┐   │
  │  │  bUseGrid = true인 경우:                                                    │   │
  │  │    DoForXXXCells → 공간 해시 위치 지정                                      │   │
  │  │    DoForHitGridCellsAndOverflow → 그리드와 오버플로 데이터 병합             │   │
  │  │                                                                             │   │
  │  │  bUseGrid = false인 경우:                                                   │   │
  │  │    직접 순회                                                                │   │
  │  └─────────────────────────────────────────────────────────────────────────────┘   │
  │                                                                                     │
  │  결과: FSimOverlapVisitor::VisitOverlap                                            │
  │        → 입자 Handle을 Context.Overlaps에 삽입                                     │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔶 6. Narrow Phase (정밀 충돌 검출)

### 6.1 Narrow Phase 전체 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    FSpatialAccelerationCollisionDetector::RunNarrowPhase                 │
│                              (정밀 충돌 검출 단계)                                        │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                         시작
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FSpatialAccelerationBroadPhase::ProduceCollisions                                  │
  │  (BroadPhase에서 생성된 충돌 제약 생성)                                              │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  MidPhase 생성 및 분배                                                              │
  │                                                                                     │
  │  1. CreateMidPhase: 입자 쌍 생성, NewMidPhases에 추가, Init()                       │
  │     - CCD가 활성화된 입자가 있으면 Flag.bIsCCD, Flag.bIsCCDActive 업데이트          │
  │                                                                                     │
  │  2. ApplyFilter: 입자 충돌 허용 여부 판단                                           │
  │                                                                                     │
  │  3. RedistributeMidPhasesInContexts: MidPhase 수량 재분배 (균등 처리)               │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FSpatialAccelerationBroadPhase::ProcessMidPhases                                   │
  │                                                                                     │
  │  BroadphaseContexts 순회:                                                           │
  │    MidPhases 순회 → FParticlePairMidPhase::GenerateCollisions                       │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FShapePairParticlePairMidPhase::GenerateCollisionsImpl                             │
  │                                                                                     │
  │  ShapePairDetectors 순회:                                                           │
  │                                                                                     │
  │    ┌─────────────────────────────────────────────────────────────────────────────┐ │
  │    │  Flags.bIsActive = true일 때:                                               │ │
  │    │                                                                             │ │
  │    │  1. RelativeMovement 업데이트                                               │ │
  │    │  2. 속도에 따라 CullDistance 확장                                           │ │
  │    │                                                                             │ │
  │    │  ┌───────────────────────┐    ┌───────────────────────────────────────────┐│ │
  │    │  │ !Flags.bIsMACD       │    │ Flags.bIsCCDActive                        ││ │
  │    │  │ (일반 충돌)          │    │ (CCD 충돌)                                 ││ │
  │    │  │                       │    │                                           ││ │
  │    │  │ GenerateCollision()   │    │ GenerateCollisionCCD()                    ││ │
  │    │  │ → CreateConstraint()  │    │ → CCD 관련 파라미터 업데이트              ││ │
  │    │  │ → 제약 파라미터 업데이트│   │   CCDEnabled, CCDSweepEnabled            ││ │
  │    │  └───────────────────────┘    └───────────────────────────────────────────┘│ │
  │    └─────────────────────────────────────────────────────────────────────────────┘ │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FPBDCollisionConstraints::EndDetectCollisions                                      │
  │                                                                                     │
  │  1. ProcessNewItems → ProcessNewMidPhases → ProcessNewConstraints                   │
  │  2. PruneEdgeCollisions                                                             │
  │  3. FCollisionConstraintAllocator::EndDetectCollisions                              │
  │     → LastUsedEpoch 업데이트                                                        │
  │     → ResetModifications                                                            │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 충돌 검출 알고리즘

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           충돌 검출 알고리즘 개요                                        │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  GJK (Gilbert-Johnson-Keerthi)                                                      │
  │  ─────────────────────────────                                                      │
  │  두 볼록 집합 사이의 최소 거리를 결정하는 방법                                       │
  │  민코프스키 차집합(Minkowski Difference)을 사용하여 볼록체 교차 여부 판단            │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  EPA (Expanding Polytope Algorithm)                                                 │
  │  ────────────────────────────────                                                   │
  │  GJK의 보충 알고리즘                                                                │
  │  침투 깊이(penetration depth)와 방향 계산에 사용                                    │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  SAT (Separating Axis Theorem) - 분리축 정리                                        │
  │  ─────────────────────────────────────────                                          │
  │  두 볼록 다각형의 교차 여부를 검출하는 효율적인 알고리즘                             │
  │                                                                                     │
  │  핵심 아이디어:                                                                     │
  │  - 한 직선(분리축)이 존재하여 두 물체의 투영 구간이 겹치지 않으면 → 교차하지 않음   │
  │  - 모든 가능한 축에서 투영이 모두 겹치면 → 물체가 교차                              │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  Bounding Volumes (경계 볼륨)                                                       │
  │  ───────────────────────────                                                        │
  │                                                                                     │
  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐         │
  │  │ AABB                │  │ OBB                 │  │ K-DOP               │         │
  │  │ (Axis-Aligned       │  │ (Oriented           │  │ (Discrete Oriented  │         │
  │  │  Bounding Box)      │  │  Bounding Box)      │  │  Polytope)          │         │
  │  │                     │  │                     │  │                     │         │
  │  │ - 좌표축 정렬       │  │ - 방향 있는 박스    │  │ - 고정 방향 평면    │         │
  │  │ - 계산 단순         │  │ - 더 조밀한 포위    │  │ - AABB보다 조밀     │         │
  │  │ - 메모리 효율적     │  │ - 계산 복잡         │  │ - OBB보다 효율적    │         │
  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘         │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  공간 분할 구조                                                                     │
  │  ──────────────                                                                     │
  │                                                                                     │
  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐         │
  │  │ Uniform Grid        │  │ Octree              │  │ BVH                 │         │
  │  │ (균일 그리드)       │  │ (옥트리)            │  │ (Bounding Volume    │         │
  │  │                     │  │                     │  │  Hierarchy)         │         │
  │  │ - 공간을 균일하게   │  │ - 공간을 재귀적으로│  │ - 경계 박스 기반    │         │
  │  │   분할              │  │   8등분             │  │   트리 구조         │         │
  │  │ - 구현 단순         │  │ - 동적 씬에 적합   │  │ - 루트가 전체 씬    │         │
  │  │ - 메모리 소비 큼    │  │                     │  │   포함              │         │
  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘         │
  │                                                                                     │
  │  ┌─────────────────────┐  ┌─────────────────────┐                                  │
  │  │ k-d Tree            │  │ BSP Tree            │                                  │
  │  │                     │  │                     │                                  │
  │  │ - 이진 트리로 공간  │  │ - 초평면으로 공간  │                                  │
  │  │   분할              │  │   재귀 분할         │                                  │
  │  │ - 대규모 씬에 효율적│  │ - 이진 트리 형성   │                                  │
  │  └─────────────────────┘  └─────────────────────┘                                  │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔷 7. Constraint Graph & Island

### 7.1 Constraint Graph 생성

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    CreateConstraintGraph (제약 그래프 생성)                              │
│                    입자 = 노드, 제약 = 엣지                                              │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                         시작
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FPBDIslandManager::UpdateParticles                                                 │
  │                                                                                     │
  │  Nodes 정순회 → UpdateGraphNode 호출                                                │
  │    - 등록된 입자의 상태 변화 처리                                                   │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  UpdateGraphNode 처리                                                               │
  │                                                                                     │
  │  ┌─────────────────────────────────────────────────────────────────────────────┐   │
  │  │  입자가 Dynamic인 경우:                                                     │   │
  │  │    - Dynamic 상태가 변경되었으면 EnqueueIslandCheckSleep으로 CheckSleep 활성화 │  │
  │  │    - UpdateGraphNodeSleepSettings로 SleepLTSq, SleepATSq 등 파라미터 업데이트 │  │
  │  │                                                                             │   │
  │  │  입자가 moving Kinematic인 경우:                                            │   │
  │  │    - Edge 순회, EnqueueIslandCheckSleep 실행, bIsSleepAllowed = false       │   │
  │  │                                                                             │   │
  │  │  입자가 Dynamic이 아닌 경우:                                                │   │
  │  │    - RemoveNodeFromIsland로 Node 제거                                       │   │
  │  └─────────────────────────────────────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  ConstraintContainers 순회 → AddConstraintsToGraph                                  │
  │                                                                                     │
  │  제약이 GraphEdge에 없으면:                                                         │
  │    CreateGraphEdge로 Edge 생성 → AssignEdgeIsland로 Island에 추가                   │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Island 생성 및 관리

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    CreateIslands (Island 생성 - 최적화)                                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                         시작
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FPBDIslandManager::UpdateIslands → ProcessIslands                                  │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
          ┌────────────────┼────────────────────────┐
          ▼                ▼                        ▼
  ┌───────────────┐  ┌───────────────┐      ┌───────────────────────┐
  │ ProcessWakes  │  │ ProcessSplits │      │ ProcessMerges         │
  │ (활성화 처리) │  │ (분리 처리)   │      │ (병합 처리)           │
  └───────┬───────┘  └───────┬───────┘      └───────────┬───────────┘
          │                  │                          │
          │                  │                          │
          ▼                  ▼                          ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  ProcessSplits 상세                                                                 │
  │                                                                                     │
  │  Islands 역순회 (요소 삭제 편의):                                                   │
  │    bItemsRemoved이면 ProcessIslandSplits 실행                                       │
  │                                                                                     │
  │  ProcessIslandSplits:                                                               │
  │    1. Nodes 순회, Node의 Island 관련 파라미터 리셋                                  │
  │    2. ContainerEdges 중 제약 Edge 순회, Edge의 Island 관련 파라미터 리셋           │
  │    3. 원래 Island의 Nodes 데이터를 임시 변수 IslandNodes로 이동; 원래 Island 정리  │
  │    4. BFS로 IslandNodes 순회, 제약 Edge를 새 Island에 추가하고 연결 노드 처리      │
  │    5. Island 업데이트, 원래 Island의 관련 파라미터 상속                             │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  ProcessMerges 상세                                                                 │
  │                                                                                     │
  │  Edges 순회 → MergeNodeIslands 실행                                                 │
  │                                                                                     │
  │  MergeNodeIslands:                                                                  │
  │    - 두 Island가 모두 존재: MergeIslands로 병합                                     │
  │    - 하나만 존재: Island가 없는 노드를 존재하는 Island에 추가                       │
  │    - 둘 다 없음: Island 생성, 두 노드 모두 추가                                     │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FinalizeIslands                                                                    │
  │                                                                                     │
  │  1. AssignLevels: Edge 순회, 비Dynamic 입자면 Level=1로 설정, NodeQueue에 추가      │
  │                   BFS로 NodeQueue 순회, Level 증가                                  │
  │                                                                                     │
  │  2. SortIslandEdges: ContainerEdges 순회, 우선순위별로 Edge 정렬, Index 업데이트    │
  │                                                                                     │
  │  3. AssignIslandLevels: Islands 순회, 활성화되고 Item 변화가 있으면 실행            │
  │                                                                                     │
  │  4. Sleep 처리: bCheckSleep시 Island의 bIsSleeping 업데이트                         │
  │                 (모든 노드가 sleep이면 true)                                        │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 Island Group 빌드 및 Solve

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    FPBDIslandGroupManager::BuildGroups                                   │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                         시작
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  1. Islands 순회, 조건 만족하는 Island를 임시 변수 Islands에 추가                   │
  │     조건: 활성화 && 제약 수 > 0 && (!시뮬레이션 중 || 시뮬레이션 필요)             │
  │                                                                                     │
  │  2. Islands를 제약 수에 따라 정렬                                                   │
  │                                                                                     │
  │  3. 작업 분배 수 계산: TargetNumConstraintsPerTask, TargetNumBodiesPerTask          │
  │                                                                                     │
  │  4. IslandGroups 순회 및 리셋                                                       │
  │                                                                                     │
  │  5. 임시 Islands 순회, 적합한 그룹 찾아 IslandGroups에 삽입                         │
  │                                                                                     │
  │  6. IslandGroups 순회, SetIterationSettings로 반복 횟수 업데이트                    │
  └─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    FPBDIslandGroupManager::Solve (★ 핵심 해석 단계 ★)                   │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                         시작
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  ActiveGroups 순회 → CreateAndDispatchWhenReady로 Event 생성                        │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  FPBDIslandConstraintGroupSolver 획득                                               │
  │  FPBDConstraintGroupSolver::AddConstraintsAndBodies                                 │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  1. GatherBodies()                                                                  │
  │     SolverBodies 순회, Event 생성, GatherBodies() 호출                              │
  │     Bodies 수집, GatherBodyEvents에 추가                                            │
  │                                                                                     │
  │     FSolverBodyContainer::GatherInput                                               │
  │     → SolverBody 순회, UpdateSolverBodyFromParticle 실행                            │
  │     → Particle 정보를 FSolverBody에 할당 (X, R, P, Q, CoM, RoM, V, W, InvM 등)      │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  2. GatherConstraints()                                                             │
  │     Constraints 순회, Event 생성, GatherConstraints() 호출                          │
  │     제약 수집, GatherConstraintEvents에 추가                                        │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  3. SolveGroupConstraints() ★                                                       │
  │     제약 수집 완료 후 Event 생성                                                    │
  │                                                                                     │
  │     ┌─────────────────────────────────────────────────────────────────────────────┐│
  │     │  PreApplyPositionConstraints                                                ││
  │     │  ApplyPositionConstraints       ← 위치 제약 적용                            ││
  │     │  PreApplyVelocityConstraints                                                ││
  │     │  ApplyVelocityConstraints       ← 속도 제약 적용                            ││
  │     │  PreApplyProjectionConstraints                                              ││
  │     │  ApplyProjectionConstraints     ← 투영 제약 적용                            ││
  │     └─────────────────────────────────────────────────────────────────────────────┘│
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  4. ScatterConstraints()                                                            │
  │     Constraints 순회, Event 생성, ScatterConstraints() 호출                         │
  │     ScatterEvents에 추가                                                            │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  5. ScatterBodies()                                                                 │
  │     SolverBodies 순회, Event 생성, ScatterBodies() 호출                             │
  │     ScatterEvents에 추가                                                            │
  │                                                                                     │
  │     FSolverBodyContainer::ScatterOutput                                             │
  │     → SolverBody 순회, UpdateParticleFromSolverBody                                 │
  │     → SolverBody의 일부 파라미터를 RigidParticle에 할당 (P, Q, V, W)                │
  └─────────────────────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  6. Scatter 완료 후 DontCompleteUntil() 호출                                        │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔶 8. FSolverBody 속성 설명

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           FSolverBody 주요 속성                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  위치 및 회전                                                                       │
  ├─────────────────────────────────────────────────────────────────────────────────────┤
  │  FVec3 X              // 서브스텝 시작 시 WorldSpace 질심 위치                      │
  │  FRotation3 R         // 서브스텝 시작 시 WorldSpace 질심 회전                      │
  │  FVec3 P              // 예측된 WorldSpace 질심 위치                                │
  │  FRotation3 Q         // 예측된 WorldSpace 질심 회전                                │
  │  FSolverVec3 DP       // 제약 위치 차이값                                           │
  │  FSolverVec3 DQ       // 제약 회전 차이값                                           │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  속도                                                                               │
  ├─────────────────────────────────────────────────────────────────────────────────────┤
  │  FSolverVec3 V        // WorldSpace 질심 선속도                                     │
  │  FSolverVec3 W        // WorldSpace 질심 각속도                                     │
  │  PreV                 // 이전 속도                                                  │
  │  PreW                 // 이전 각속도                                                │
  │  VSmooth              // 선속도 평활값                                              │
  │  WSmooth              // 각속도 평활값                                              │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  질량 및 관성                                                                       │
  ├─────────────────────────────────────────────────────────────────────────────────────┤
  │  FSolverReal InvM     // 역질량                                                     │
  │  FSolverVec3 InvILocal// LocalSpace 역관성                                          │
  │  FSolverMatrix33 InvI // WorldSpace 역관성                                          │
  │  FVec3 CoM            // ActorSpace 질심 위치                                       │
  │  FRotation3 RoM       // ActorSpace 질심 회전                                       │
  │  ConditionedInvI      // 관성 역텐서                                                │
  │  ConditionedI         // 관성 텐서                                                  │
  │  InvIConditioning     // 관성 조정 비율                                             │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  힘 및 임펄스                                                                       │
  ├─────────────────────────────────────────────────────────────────────────────────────┤
  │  Acceleration         // 가속도                                                     │
  │  AngularAcceleration  // 각가속도                                                   │
  │  Torque               // 토크                                                       │
  │  LinearImpulseVelocity// 선형 임펄스 속도                                           │
  │  AngularImpulseVelocity// 각 임펄스 속도                                            │
  └─────────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
  │  기타                                                                               │
  ├─────────────────────────────────────────────────────────────────────────────────────┤
  │  int32 Level          // Kinematic body까지의 거리 (충돌 충격 전파용)               │
  │  FState State         // 상태                                                       │
  │  UniqueIdx            // 입자 고유 ID                                               │
  │  SolverBodyIndex      // Body 해석 시 사용                                          │
  │  KinematicTarget      // 운동학 목표                                                │
  │  FSolverVec3 CP/CQ    // 제약 관련                                                  │
  └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔗 관련 문서

- [Chaos_Complete_Architecture.md](Chaos_Complete_Architecture.md) - 전체 아키텍처
- [Chaos_Threading_And_Synchronization.md](Chaos_Threading_And_Synchronization.md) - 스레딩 동기화
- [Chaos_DirtySet_Deep_Dive.md](Chaos_DirtySet_Deep_Dive.md) - DirtySet 상세
- [Chaos_Debug_And_Profiling.md](Chaos_Debug_And_Profiling.md) - 디버그 및 프로파일링

---

## 📚 참조

- 图解Chaos源码 (爱吃菠萝不吃萝卜)
- https://github.com/xiaxia9/Game-Development-Notes

---

> 이 문서는 Chaos Physics 엔진의 전체 실행 흐름을 시각적으로 설명합니다.
> 🔄 Updated: 2025-12-11 — 初版 작성
