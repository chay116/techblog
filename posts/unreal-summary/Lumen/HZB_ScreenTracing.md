---
title: "Lumen HZB (Hierarchical Z-Buffer) ìŠ¤í¬ë¦° ìŠ¤í˜ì´ìŠ¤ íŠ¸ë ˆì´ì‹±"
date: "2025-12-02"
status: "stable"
project: "UnrealEngine"
lang: "ko"
category: "unreal-summary"
track: "Lumen"
tags: ["unreal", "Lumen"]
---
# Lumen HZB (Hierarchical Z-Buffer) ìŠ¤í¬ë¦° ìŠ¤í˜ì´ìŠ¤ íŠ¸ë ˆì´ì‹±

## ğŸ¯ Overview

Lumenì€ **Closest HZB**(ê°€ì¥ ê°€ê¹Œìš´ ê¹Šì´ê°’ì˜ ê³„ì¸µ êµ¬ì¡°)ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤í¬ë¦° ìŠ¤í˜ì´ìŠ¤ì—ì„œ íš¨ìœ¨ì ì¸ ë ˆì´ íŠ¸ë ˆì´ì‹±ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´ëŠ” Screen Probe Gather, Reflections, Bent Normal ê³„ì‚°ì— í™œìš©ë©ë‹ˆë‹¤.

**í•µì‹¬ ê°œë…:**
> HZBëŠ” ê¹Šì´ ë²„í¼ì˜ **ë°‰ë§µ í”¼ë¼ë¯¸ë“œ**ì…ë‹ˆë‹¤. ê° ë°‰ ë ˆë²¨ì—ì„œ ê¹Šì´ì˜ ìµœì†Ÿê°’(Closest) ë˜ëŠ” ìµœëŒ“ê°’(Furthest)ì„ ì €ì¥í•˜ì—¬, ë ˆì´ê°€ ê¸°í•˜ êµ¬ì¡°ì™€ êµì°¨í•˜ëŠ”ì§€ **ê³„ì¸µì ìœ¼ë¡œ** ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“‚ í•µì‹¬ íŒŒì¼ ìœ„ì¹˜

### C++ í—¤ë”/êµ¬í˜„
| íŒŒì¼ | ì—­í•  |
|------|------|
| `Engine/Source/Runtime/Renderer/Private/HZB.h:14-42` | FHZBParameters êµ¬ì¡°ì²´ ì •ì˜ |
| `Engine/Source/Runtime/Renderer/Private/Lumen/LumenTracingUtils.h:132-141` | FLumenHZBScreenTraceParameters |
| `Engine/Source/Runtime/Renderer/Private/Lumen/LumenReflectionTracing.cpp:1023-1107` | SetupHZBScreenTraceParameters() |
| `Engine/Source/Runtime/Renderer/Private/SceneOcclusion.cpp:71-77` | HZB ìƒì„± íŒŒì´í”„ë¼ì¸ |

### ì…°ì´ë”
| íŒŒì¼ | ì—­í•  |
|------|------|
| `Engine/Shaders/Private/HZB.ush` | HZB í…ìŠ¤ì²˜ ì„ ì–¸ |
| `Engine/Shaders/Private/HZBTracing.ush:1-251` | **TraceHZB()** í•µì‹¬ ì•Œê³ ë¦¬ì¦˜ |
| `Engine/Shaders/Private/Lumen/LumenScreenTracing.ush:1-199` | Lumen ìŠ¤í¬ë¦° íŠ¸ë ˆì´ì‹± ë˜í¼ |

---

## ğŸ“ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ë°ì´í„° íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Scene Rendering Pass                              â”‚
â”‚                      (GBuffer Depth ìƒì„±)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ SceneDepthTexture
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SceneOcclusion::RenderHzb()                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì…ë ¥: Scene Depth Texture                                              â”‚
â”‚  ì¶œë ¥:                                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚   ClosestHZB        â”‚   â”‚   FurthestHZB       â”‚                   â”‚
â”‚    â”‚  (ìµœì†Œ ê¹Šì´ ë°‰ë§µ)    â”‚   â”‚  (ìµœëŒ€ ê¹Šì´ ë°‰ë§µ)    â”‚                   â”‚
â”‚    â”‚  - Lumen ì‚¬ìš©       â”‚   â”‚  - Occlusionìš©      â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  í•´ìƒë„: Mip 0 = 1/2 í•´ìƒë„, ì´í›„ 2ë°°ì”© ê°ì†Œ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ View.ClosestHZB
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SetupHZBScreenTraceParameters()                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì…ë ¥: View.ClosestHZB                                                  â”‚
â”‚  ì¶”ê°€: ì´ì „ í”„ë ˆì„ Scene Color + Depth (ê²€ì¦ìš©)                          â”‚
â”‚  ì¶œë ¥: FLumenHZBScreenTraceParameters                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Lumen Screen Trace Shaders                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ScreenProbeTraceScreenTexturesCS    (Screen Probe GI)               â”‚
â”‚  â€¢ ReflectionTraceScreenTexturesCS     (Screen Space Reflections)      â”‚
â”‚  â€¢ LumenScreenSpaceBentNormalCS        (AO / Bent Normal)              â”‚
â”‚                                                                         â”‚
â”‚            TraceScreen() â†’ TraceHZB()                                  â”‚
â”‚                                                                         â”‚
â”‚  ì‚¬ìš©:                                                                  â”‚
â”‚    - ClosestHZBTexture: ê³„ì¸µì  ë ˆì´ ìˆœíšŒ                                â”‚
â”‚    - PrevSceneColorTexture: Hit ì‹œ ë˜ë””ì–¸ìŠ¤ ìƒ˜í”Œë§                      â”‚
â”‚    - HistorySceneDepth: Hit ê²€ì¦                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§± í•µì‹¬ ë°ì´í„° êµ¬ì¡°

### FHZBParameters (HZB.h:14-42)

```cpp
BEGIN_SHADER_PARAMETER_STRUCT(FHZBParameters, )
    // HZB í…ìŠ¤ì²˜ (ë°‰ë§µ ê¹Šì´ ê³„ì¸µ)
    SHADER_PARAMETER_RDG_TEXTURE(Texture2D, HZBTexture)           // Furthest HZB
    SHADER_PARAMETER_RDG_TEXTURE(Texture2D, ClosestHZBTexture)    // Closest HZB â† Lumen ì‚¬ìš©
    SHADER_PARAMETER_RDG_TEXTURE(Texture2D, FurthestHZBTexture)

    // ìƒ˜í”ŒëŸ¬
    SHADER_PARAMETER_SAMPLER(SamplerState, ClosestHZBTextureSampler)

    // í¬ê¸° ë° ìŠ¤ì¼€ì¼ë§
    SHADER_PARAMETER(FVector2f, HZBSize)                    // ì „ì²´ í•´ìƒë„
    SHADER_PARAMETER(FVector2f, HZBViewSize)                // ë·° í¬ê¸°
    SHADER_PARAMETER(FVector2f, HZBBaseTexelSize)           // ê¸°ë³¸ ë°‰ í…ì…€ í¬ê¸°
    SHADER_PARAMETER(FVector4f, HZBUvFactorAndInvFactor)    // UV ë³€í™˜ íŒ©í„°
    SHADER_PARAMETER(FVector4f, HZBUVToScreenUVScaleBias)   // ìŠ¤í¬ë¦° ì¢Œí‘œ ë³€í™˜

    // ìœ íš¨ì„± í”Œë˜ê·¸
    SHADER_PARAMETER(uint32, bIsClosestHZBValid)
END_SHADER_PARAMETER_STRUCT()
```

### FLumenHZBScreenTraceParameters (LumenTracingUtils.h:132-141)

```cpp
BEGIN_SHADER_PARAMETER_STRUCT(FLumenHZBScreenTraceParameters, )
    // ì´ì „ í”„ë ˆì„ Scene Color (Hit ì‹œ ìƒ‰ìƒ ìƒ˜í”Œë§)
    SHADER_PARAMETER_RDG_TEXTURE_SRV(Texture2D, PrevSceneColorTexture)

    // íˆìŠ¤í† ë¦¬ ê¹Šì´ (Hit ê²€ì¦ìš©)
    SHADER_PARAMETER_RDG_TEXTURE(Texture2D, HistorySceneDepth)

    // HZB íŒŒë¼ë¯¸í„° ì „ì²´ í¬í•¨
    SHADER_PARAMETER_STRUCT_INCLUDE(FHZBParameters, HZBParameters)

    // ì´ì „ í”„ë ˆì„ ì¢Œí‘œ ë³€í™˜
    SHADER_PARAMETER(FVector4f, PrevScreenPositionScaleBias)
    SHADER_PARAMETER(float, PrevSceneColorPreExposureCorrection)
END_SHADER_PARAMETER_STRUCT()
```

---

## ğŸ§© TraceHZB ì•Œê³ ë¦¬ì¦˜ ìƒì„¸

### ì „ì²´ íë¦„ (HZBTracing.ush:33-251)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TraceHZB() - Stackless ìˆœíšŒ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ì…ë ¥:                                                                  â”‚
â”‚    â€¢ Ray: ì›”ë“œ ê³µê°„ ì›ì  & ë°©í–¥                                          â”‚
â”‚    â€¢ ClosestHZBTexture: ë°‰ë§µ ìµœì†Œ ê¹Šì´                                   â”‚
â”‚    â€¢ MaxIterations: ë°˜ë³µ ì œí•œ (~50)                                     â”‚
â”‚    â€¢ RelativeDepthThickness: Hit í—ˆìš© ì˜¤ì°¨ (ê¸°ë³¸ 2%)                     â”‚
â”‚                                                                         â”‚
â”‚  ì²˜ë¦¬ ê³¼ì •:                                                              â”‚
â”‚    1. ë ˆì´ë¥¼ ìŠ¤í¬ë¦° UV ê³µê°„ìœ¼ë¡œ ë³€í™˜                                      â”‚
â”‚    2. í™”ë©´ ê²½ê³„ë¡œ ë ˆì´ í´ë¦¬í•‘                                             â”‚
â”‚    3. í˜„ì¬ íƒ€ì¼ì—ì„œ ë²—ì–´ë‚˜ê¸° (Self-intersection ë°©ì§€)                     â”‚
â”‚    4. Stackless HZB ìˆœíšŒ ë£¨í”„:                                          â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚       â”‚  íƒ€ì¼ í‰ë©´ êµì°¨ì  ê³„ì‚°               â”‚                         â”‚
â”‚       â”‚          â†“                           â”‚                         â”‚
â”‚       â”‚  HZB ìƒ˜í”Œë§ (í˜„ì¬ ë°‰ ë ˆë²¨)           â”‚                         â”‚
â”‚       â”‚          â†“                           â”‚                         â”‚
â”‚       â”‚  ë ˆì´ ê¹Šì´ vs íƒ€ì¼ ê¹Šì´ ë¹„êµ          â”‚                         â”‚
â”‚       â”‚          â†“                           â”‚                         â”‚
â”‚       â”‚  í‘œë©´ ìœ„? â†’ ë°‰ ì¦ê°€ (Coarsen)        â”‚                         â”‚
â”‚       â”‚  í‘œë©´ ì•„ë˜? â†’ ë°‰ ê°ì†Œ (Refine)       â”‚                         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚    5. ë‘ê»˜ í…ŒìŠ¤íŠ¸ (ì–‡ì€ í”¼ì³ ê²€ì¶œ)                                       â”‚
â”‚    6. Hit ì¢Œí‘œë¥¼ ìŠ¤í¬ë¦° UVë¡œ ë³€í™˜                                        â”‚
â”‚                                                                         â”‚
â”‚  ì¶œë ¥:                                                                  â”‚
â”‚    â€¢ bHit: êµì°¨ ë°œìƒ ì—¬ë¶€                                               â”‚
â”‚    â€¢ bUncertain: ì–‡ì€ í”¼ì³ì¼ ê°€ëŠ¥ì„±                                     â”‚
â”‚    â€¢ OutScreenUV: Hit ìœ„ì¹˜ (ìŠ¤í¬ë¦° ê³µê°„)                                â”‚
â”‚    â€¢ OutHitTileZ: Hit ê¹Šì´ (í›„ì²˜ë¦¬ ê²€ì¦ìš©)                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í•µì‹¬ ì•Œê³ ë¦¬ì¦˜ ì½”ë“œ (HZBTracing.ush:77-189)

```hlsl
float BaseMipLevel = HZB_TRACE_INCLUDE_FULL_RES_DEPTH ? -1 : 0;
float MipLevel = BaseMipLevel;  // Mip -1 = í’€í•´ìƒë„ ê¹Šì´, 0+ = ì¶•ì†Œëœ ë°‰

while (MipLevel >= BaseMipLevel && NumIterations < MaxIterations)
{
    // í˜„ì¬ ë°‰ì˜ í…ì…€ í¬ê¸°
    float2 CurrentMipTexelSize = exp2(MipLevel) * HZBBaseTexelSize;
    float2 CurrentMipResolution = 1.0f / CurrentMipTexelSize;

    // í˜„ì¬ ë°‰ì—ì„œ íƒ€ì¼ ê¹Šì´ ìƒ˜í”Œë§
    float TileZ;
    if (MipLevel < 0)
        TileZ = SceneDepthTexture.SampleLevel(..., 0);    // í’€ í•´ìƒë„
    else
        TileZ = ClosestHZBTexture.SampleLevel(..., MipLevel);

    // íƒ€ì¼ XY ë° Z í‰ë©´ê³¼ì˜ êµì°¨ ì‹œê°„ ê³„ì‚°
    float3 BoundaryPlanes = float3(TileXY, TileZ);
    float3 PlaneIntersectionTimes = (BoundaryPlanes - RayStart) / RayDirection;
    float IntersectionTime = min(PlaneIntersectionTimes.x, PlaneIntersectionTimes.y);

    // ë ˆì´ê°€ í‘œë©´ ìœ„ì¸ì§€ ì•„ë˜ì¸ì§€ í…ŒìŠ¤íŠ¸
    bool bAboveSurface = RayScreenUV.z > TileZ;

    if (bAboveSurface)
        MipLevel += 1;  // Coarsen: ë” í° íƒ€ì¼ë¡œ, ê±´ë„ˆë›°ê¸°
    else
        MipLevel -= 1;  // Refine: ë” ì‘ì€ íƒ€ì¼ë¡œ, ì •ë°€í™”
}
```

### ë°‰ ë ˆë²¨ ìˆœíšŒ ì‹œê°í™”

```
                    Mip 3 (1/16 í•´ìƒë„)
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚                 â”‚
                   â”‚   ë ˆì´ ìœ„?      â”‚ â†’ ê±´ë„ˆë›°ê¸°
                   â”‚   â†’ Mip 4ë¡œ    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ ë ˆì´ ì•„ë˜? â†’ Refine
                            â–¼
                    Mip 2 (1/8 í•´ìƒë„)
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚        â”‚        â”‚        â”‚        â”‚
           â”‚        â”‚   â˜…    â”‚        â”‚        â”‚  â˜… = í˜„ì¬ íƒ€ì¼
           â”‚        â”‚        â”‚        â”‚        â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ ë ˆì´ ì•„ë˜? â†’ ë” ì •ë°€í™”
                         â–¼
                    Mip 1 (1/4 í•´ìƒë„)
     â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
     â”‚    â”‚    â”‚    â”‚ â˜…  â”‚    â”‚    â”‚    â”‚    â”‚
     â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”¬â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
                      â”‚ ê³„ì† Refine...
                      â–¼
                    Mip 0 (1/2 í•´ìƒë„) â†’ Hit ë˜ëŠ” Miss ê²°ì •
```

---

## ğŸ”§ ë‘ê»˜ í…ŒìŠ¤íŠ¸ (Thickness Testing)

ì–‡ì€ í”¼ì³(í’€, ë¨¸ë¦¬ì¹´ë½ ë“±)ì˜ ì˜ëª»ëœ ê°€ë¦¼ ë°©ì§€:

```hlsl
// HZBTracing.ush:216-238
if (bHit && NumThicknessStepsToDetermineCertainty > 0)
{
    for (float I = 0; I < NumSteps; I++)
    {
        float3 SampleUV = RayScreenUV + (I / NumSteps) * SampleDistance;
        float SampleTileZ = ClosestHZBTexture.SampleLevel(..., 0);

        // Hit ë’¤ì—ì„œ í‘œë©´ ìœ„ í”½ì…€ ë°œê²¬ â†’ ì–‡ì€ í”¼ì³
        if (SampleUV.z > SampleTileZ)
            bUncertain = true;
    }
}
```

```
      Hit Point
         â†“
   â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Surface A (ì–‡ì€ í”¼ì³)
         â”‚
         â”‚  â† ì´ ì˜ì—­ ìƒ˜í”Œë§
         â”‚
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Surface B (ì‹¤ì œ ë°°ê²½)

   Surface Bê°€ ë³´ì´ë©´ â†’ bUncertain = true
```

---

## ğŸ’¡ Lumen vs ì¼ë°˜ Scene HZB

| í•­ëª© | Lumen HZB | ì¼ë°˜ Scene HZB |
|------|-----------|----------------|
| **ê¹Šì´ íƒ€ì…** | Closest (ìµœì†Ÿê°’) | Furthest (ìµœëŒ“ê°’) |
| **ëª©ì ** | ìŠ¤í¬ë¦° íŠ¸ë ˆì´ì‹± ì‹œ ëª¨ë“  ê°€ë¦¼ ê²€ì¶œ | Occlusion Culling, Shadow Map |
| **í•´ìƒë„** | ì„ íƒì  í’€í•´ìƒë„ í¬í•¨ | ì¼ë°˜ì ìœ¼ë¡œ 1/2 í•´ìƒë„ ì‹œì‘ |
| **íˆìŠ¤í† ë¦¬** | ì´ì „ í”„ë ˆì„ ê¹Šì´ë¡œ ê²€ì¦ | ì‚¬ìš© ì•ˆ í•¨ |

**ì™œ ClosestHZBì¸ê°€?**
> ìŠ¤í¬ë¦° ìŠ¤í˜ì´ìŠ¤ ë¦¬í”Œë ‰ì…˜/GI ë ˆì´ëŠ” **ì–´ë–¤ í‘œë©´ì´ë“ ** ê°€ë¦¬ë©´ ë©ˆì¶°ì•¼ í•©ë‹ˆë‹¤.
> FurthestHZBëŠ” "ê°€ì¥ ë¨¼" í‘œë©´ë§Œ ì €ì¥í•˜ë¯€ë¡œ, ì•ì— ìˆëŠ” ì–‡ì€ ë¬¼ì²´ë¥¼ ë†“ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## âš™ï¸ ì£¼ìš” ì½˜ì†” ë³€ìˆ˜

```
r.Lumen.ScreenProbeGather.ScreenTraces.HZBTraversal = 1
    HZB ìˆœíšŒ í™œì„±í™” (0 = ê³ ì • ìŠ¤í… ì¹´ìš´íŠ¸)

r.Lumen.ScreenProbeGather.ScreenTraces.HZBTraversal.FullResDepth = 1
    í’€í•´ìƒë„ ê¹Šì´ í¬í•¨ (ë” ì •í™•, ë” ë¹„ì¼ê´€ì )

r.Lumen.ScreenProbeGather.ScreenTraces.HZBTraversal.RelativeDepthThickness = 0.02
    ê¹Šì´ ë‘ê»˜ í—ˆìš© ì˜¤ì°¨ (ì”¬ ê¹Šì´ì˜ %)

r.Lumen.ScreenProbeGather.ScreenTraces.HZBTraversal.MaxIterations = 50
    ë ˆì´ë‹¹ ìµœëŒ€ HZB ìˆœíšŒ ë°˜ë³µ íšŸìˆ˜
```

---

## âš¡ ì„±ëŠ¥ íŠ¹ì„±

**HZB vs ê³ ì • ìŠ¤í…:**
```cpp
// LumenScreenProbeTracing.cpp:29-35
// "HZB íŠ¸ë ˆì´ì‹±ì´ í›¨ì”¬ ì •í™•í•˜ë©°, íŠ¹íˆ ì–‡ì€ í”¼ì³ë¥¼ ë†“ì¹˜ì§€ ì•Šì§€ë§Œ,
//  ê³ ì • ìŠ¤í… êµì°¨ë³´ë‹¤ ì•½ ~3ë°° ëŠë¦¼"
```

**ìµœì í™”: ë‚®ì€ ì ìœ ìœ¨ ì‹œ ì¡°ê¸° ì¢…ë£Œ**
```hlsl
if (TERMINATE_ON_LOW_OCCUPANCY && WaveActiveCountBits(true) < MinimumTracingThreadOccupancy)
    break;  // ìŠ¤ë ˆë“œ ê·¸ë£¹ ì ìœ ìœ¨ ë‚®ìœ¼ë©´ ì¡°ê¸° ì¢…ë£Œ
```

---

## âš ï¸ ì œí•œ ì‚¬í•­ ë° ì£¼ì˜ì 

### 1. Point-Sampled ê¹Šì´
HZBëŠ” í¬ì¸íŠ¸ í•„í„°ë§ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ê¹Šì´ í…ì…€ ëª¨ì„œë¦¬ê°€ í‘œí˜„í•˜ëŠ” í‰ë©´ì—ì„œ "íŠ€ì–´ë‚˜ì˜´".

**í•´ê²°:** Lumenì€ ë ˆì´ ì‹œì‘ì ì— ë…¸ë©€ ë°”ì´ì–´ìŠ¤ë¥¼ ì¶”ê°€í•˜ì—¬ Self-intersection ë°©ì§€

### 2. ì–‡ì€ í”¼ì³ ê²€ì¶œ í•œê³„
HZBë§Œìœ¼ë¡œëŠ” ì–‡ì€/ë‘êº¼ìš´ í‘œë©´ êµ¬ë¶„ ë¶ˆê°€ â†’ Thickness Stepping íœ´ë¦¬ìŠ¤í‹± ì‚¬ìš©

### 3. ì‹œê°„ì  ì•„í‹°íŒ©íŠ¸
ì´ì „ í”„ë ˆì„ ê¹Šì´ ê²€ì¦ì€ ì¹´ë©”ë¼ ë¹ ë¥¸ ì´ë™ ì‹œ ê³ ìŠ¤íŒ… ë°œìƒ ê°€ëŠ¥

### 4. í™”ë©´ ê²½ê³„ ì²˜ë¦¬
í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ë ˆì´ëŠ” ë¨¼ ê¸°í•˜ êµ¬ì¡°ë¥¼ ì •í™•íˆ í‘œí˜„í•˜ì§€ ëª»í•¨

### 5. ì‹œì°¨ ì˜¤ë¥˜
ìŠ¤í¬ë¦° ìŠ¤í˜ì´ìŠ¤ ë ˆì´ëŠ” ì‹œì°¨ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šì•„, ì¤‘ì‹¬ì—ì„œ ë²—ì–´ë‚œ ì‹œì•¼ê°ì—ì„œ ë¶€ì •í™•

---

## ğŸ”— ì°¸ê³  ìë£Œ

- **HZB ì›ë³¸ ë…¼ë¬¸:** "Hierarchical Z-Buffer Visibility" - Greene et al.
- **UE5 Lumen ê¸°ìˆ  ë¬¸ì„œ:** https://docs.unrealengine.com/5.0/en-US/lumen-global-illumination-and-reflections-in-unreal-engine/
- **ì†ŒìŠ¤ ì½”ë“œ:** `Engine/Source/Runtime/Renderer/Private/Lumen/`

---

> ğŸ”„ Updated: 2025-12-02 â€” Lumen HZB ìŠ¤í¬ë¦° íŠ¸ë ˆì´ì‹± ì‹œìŠ¤í…œ ìµœì´ˆ ë¬¸ì„œí™”
